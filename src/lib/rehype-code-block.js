import { visit } from 'unist-util-visit';

// ËØ≠Ë®ÄÂõæÊ†áÊò†Â∞Ñ
function getLanguageIcon(language) {
  const icons = {
    javascript: 'üü®',
    typescript: 'üî∑',
    python: 'üêç',
    java: '‚òï',
    rust: 'ü¶Ä',
    go: 'üêπ',
    php: 'üêò',
    ruby: 'üíé',
    swift: 'ü¶â',
    kotlin: 'üéØ',
    dart: 'üéØ',
    c: '‚öôÔ∏è',
    cpp: '‚öôÔ∏è',
    csharp: 'üî∑',
    html: 'üåê',
    css: 'üé®',
    scss: 'üé®',
    sass: 'üé®',
    vue: 'üíö',
    react: '‚öõÔ∏è',
    angular: 'üÖ∞Ô∏è',
    svelte: 'üß°',
    astro: 'üöÄ',
    json: 'üìã',
    yaml: 'üìÑ',
    toml: 'üìÑ',
    xml: 'üìÑ',
    markdown: 'üìù',
    bash: 'üêö',
    shell: 'üêö',
    zsh: 'üêö',
    powershell: 'üíô',
    sql: 'üóÑÔ∏è',
    dockerfile: 'üê≥',
    nginx: 'üåê',
    apache: 'ü™∂',
    git: 'üåø',
    vim: 'üíö',
    emacs: 'üíú',
    default: 'üìÑ'
  };

  return icons[language.toLowerCase()] || icons.default;
}

// Ê£ÄÊµã‰ª£Á†ÅÂùóÊòØÂê¶Â∫îËØ•ÊäòÂè†
function shouldCollapse(codeText, maxLines = 15) {
  const lines = codeText.split('\n');
  return lines.length > maxLines;
}

// Ê∑ªÂä†Ë°åÂè∑Âà∞‰ª£Á†Å
function addLineNumbers(codeText) {
  return codeText.split('\n').map((line, index) => {
    return `<span class="line">${line || '\u00A0'}</span>`;
  }).join('\n');
}

export function rehypeCodeBlock() {
  return (tree) => {
    visit(tree, 'element', (node, index, parent) => {
      if (node.tagName === 'pre' && node.children[0]?.tagName === 'code') {
        const codeNode = node.children[0];
        const language = codeNode.properties?.className?.[0]?.replace('language-', '') || '';
        
        // Ëé∑Âèñ‰ª£Á†ÅÊñáÊú¨ÂÜÖÂÆπ
        let codeText = '';
        const extractText = (node) => {
          if (node.type === 'text') {
            return node.value;
          }
          if (node.children) {
            return node.children.map(extractText).join('');
          }
          return '';
        };
        codeText = extractText(codeNode);
        const lines = codeText.split('\n');
        const needsCollapse = shouldCollapse(codeText);

        // ÂàõÂª∫Â¢ûÂº∫ÁöÑÂåÖË£ÖÁªìÊûÑ
        const wrapper = {
          type: 'element',
          tagName: 'div',
          properties: {
            className: ['code-block-container'],
            'data-language': language || 'text',
            'data-lines': lines.length,
            'data-theme': 'auto'
          },
          children: [
            // ‰∏ªÈ¢òÂàáÊç¢ÊåâÈíÆ
            {
              type: 'element',
              tagName: 'button',
              properties: {
                className: ['theme-toggle-button'],
                title: 'ÂàáÊç¢‰∏ªÈ¢ò',
                'aria-label': 'ÂàáÊç¢‰ª£Á†Å‰∏ªÈ¢ò',
                type: 'button'
              },
              children: [
                {
                  type: 'element',
                  tagName: 'svg',
                  properties: {
                    width: '16',
                    height: '16',
                    viewBox: '0 0 24 24',
                    fill: 'none',
                    stroke: 'currentColor',
                    'stroke-width': '2'
                  },
                  children: [
                    {
                      type: 'element',
                      tagName: 'circle',
                      properties: {
                        cx: '12',
                        cy: '12',
                        r: '5'
                      }
                    }
                  ]
                }
              ]
            },
            // ËØ≠Ë®ÄÊ†áÁ≠æÔºàÂ∏¶ÂõæÊ†áÔºâ
            ...(language ? [{
              type: 'element',
              tagName: 'div',
              properties: {
                className: ['code-language-label']
              },
              children: [
                {
                  type: 'element',
                  tagName: 'span',
                  properties: {
                    className: ['language-icon']
                  },
                  children: [{ type: 'text', value: getLanguageIcon(language) }]
                },
                { type: 'text', value: ` ${language}` }
              ]
            }] : []),
            // Êìç‰ΩúÊåâÈíÆÁªÑ
            {
              type: 'element',
              tagName: 'div',
              properties: {
                className: ['code-actions']
              },
              children: [
                // ÂØºÂá∫ÊåâÈíÆ
                {
                  type: 'element',
                  tagName: 'button',
                  properties: {
                    className: ['action-button', 'export-button'],
                    title: 'ÂØºÂá∫‰ª£Á†Å',
                    'data-code': codeText,
                    'data-filename': `code.${language || 'txt'}`,
                    type: 'button'
                  },
                  children: [
                    {
                      type: 'element',
                      tagName: 'svg',
                      properties: {
                        width: '16',
                        height: '16',
                        viewBox: '0 0 24 24',
                        fill: 'none',
                        stroke: 'currentColor',
                        'stroke-width': '2'
                      },
                      children: [
                        {
                          type: 'element',
                          tagName: 'path',
                          properties: {
                            d: 'M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4'
                          }
                        },
                        {
                          type: 'element',
                          tagName: 'polyline',
                          properties: {
                            points: '7,10 12,15 17,10'
                          }
                        },
                        {
                          type: 'element',
                          tagName: 'line',
                          properties: {
                            x1: '12',
                            y1: '15',
                            x2: '12',
                            y2: '3'
                          }
                        }
                      ]
                    }
                  ]
                },
                // Â¢ûÂº∫ÁâàÂ§çÂà∂ÊåâÈíÆ
                {
                  type: 'element',
                  tagName: 'button',
                  properties: {
                    className: ['copy-button'],
                    'data-code': codeText,
                    title: 'Â§çÂà∂‰ª£Á†Å',
                    'aria-label': 'Â§çÂà∂‰ª£Á†ÅÂà∞Ââ™Ë¥¥Êùø',
                    type: 'button'
                  },
                  children: [
                    {
                      type: 'element',
                      tagName: 'span',
                      properties: {
                        className: ['copy-icon']
                      },
                      children: [
                        {
                          type: 'element',
                          tagName: 'svg',
                          properties: {
                            width: '18',
                            height: '18',
                            viewBox: '0 0 24 24',
                            fill: 'none',
                            stroke: 'currentColor',
                            'stroke-width': '2',
                            'stroke-linecap': 'round',
                            'stroke-linejoin': 'round',
                            className: ['copy-svg']
                          },
                          children: [
                            {
                              type: 'element',
                              tagName: 'rect',
                              properties: {
                                width: '14',
                                height: '14',
                                x: '8',
                                y: '8',
                                rx: '2',
                                ry: '2'
                              }
                            },
                            {
                              type: 'element',
                              tagName: 'path',
                              properties: {
                                d: 'm4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2'
                              }
                            }
                          ]
                        },
                        {
                          type: 'element',
                          tagName: 'svg',
                          properties: {
                            width: '18',
                            height: '18',
                            viewBox: '0 0 24 24',
                            fill: 'none',
                            stroke: 'currentColor',
                            'stroke-width': '2',
                            'stroke-linecap': 'round',
                            'stroke-linejoin': 'round',
                            className: ['check-svg'],
                            style: 'display: none;'
                          },
                          children: [
                            {
                              type: 'element',
                              tagName: 'path',
                              properties: {
                                d: 'm9 12 2 2 4-4'
                              }
                            }
                          ]
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            // ÈîÆÁõòÂø´Êç∑ÈîÆÊèêÁ§∫
            {
              type: 'element',
              tagName: 'div',
              properties: {
                className: ['keyboard-hint']
              },
              children: [
                {
                  type: 'element',
                  tagName: 'span',
                  properties: {
                    className: ['kbd']
                  },
                  children: [{ type: 'text', value: 'Ctrl+C' }]
                },
                { type: 'text', value: ' Â§çÂà∂ ' },
                {
                  type: 'element',
                  tagName: 'span',
                  properties: {
                    className: ['kbd']
                  },
                  children: [{ type: 'text', value: 'Ctrl+S' }]
                },
                { type: 'text', value: ' ÂØºÂá∫' }
              ]
            },
            // ÂéüÂßãÁöÑ pre ÂÖÉÁ¥†ÔºàÂ¢ûÂº∫Â§ÑÁêÜÔºâ
            {
              ...node,
              properties: {
                ...node.properties,
                className: [...(node.properties?.className || []), 'enhanced-pre'],
                'data-lines': lines.length
              },
              children: [
                {
                  ...codeNode,
                  children: codeNode.children.map(child => {
                    if (child.type === 'text') {
                      return {
                        ...child,
                        value: addLineNumbers(child.value)
                      };
                    }
                    return child;
                  })
                }
              ]
            },
            // ‰ª£Á†ÅË°åÊï∞ÊåáÁ§∫Âô®
            {
              type: 'element',
              tagName: 'div',
              properties: {
                className: ['code-line-indicator']
              },
              children: [
                { type: 'text', value: `${lines.length} Ë°å` }
              ]
            },
            // Â±ïÂºÄ/ÊäòÂè†ÊåâÈíÆÔºàÂ¶ÇÊûúÈúÄË¶ÅÔºâ
            ...(needsCollapse ? [{
              type: 'element',
              tagName: 'div',
              properties: {
                className: ['code-expand-container']
              },
              children: [
                {
                  type: 'element',
                  tagName: 'button',
                  properties: {
                    className: ['expand-button'],
                    'data-collapsed': 'true',
                    'data-total-lines': lines.length,
                    type: 'button'
                  },
                  children: [
                    {
                      type: 'element',
                      tagName: 'svg',
                      properties: {
                        width: '16',
                        height: '16',
                        viewBox: '0 0 24 24',
                        fill: 'none',
                        stroke: 'currentColor',
                        'stroke-width': '2',
                        className: ['expand-icon']
                      },
                      children: [
                        {
                          type: 'element',
                          tagName: 'polyline',
                          properties: {
                            points: '6,9 12,15 18,9'
                          }
                        }
                      ]
                    },
                    { type: 'text', value: ` Â±ïÂºÄÂÖ®ÈÉ® (${lines.length} Ë°å)` }
                  ]
                }
              ]
            }] : [])
          ]
        };

        // ÊõøÊç¢ÂéüËäÇÁÇπ
        parent.children[index] = wrapper;
      }
    });
  };
}
